<template>
  <span>
    <v-btn color="info"
           outline
           small
           @click="onTestClick"
           :loading="loading"
           :disabled="loading"
    >
      {{ $t('test') }}

      <v-icon small :class="['ml-2', currentGitTest.class]">{{ currentGitTest.icon }}</v-icon>

      <template v-slot:loader>
        <span class="custom-loader">
          <v-icon small light>flow-icon-loading1</v-icon>
        </span>
      </template>
    </v-btn>

    <span class="ml-2 error--text">{{ currentGitTest.message }}</span>
  </span>
</template>

<script>
  import actions from '@/store/actions'
  import { GIT_TEST_DONE, GIT_TEST_ERROR, gitTestStatus } from '@/util/flows'
  import { subscribeTopic, unsubscribeTopic } from '@/store/subscribe'
  import { mapState } from 'vuex'

  export default {
    name: 'GitTestBtn',
    props: {
      wrapper: {
        required: true,
        type: Object
      },
      onBeforeTest: {
        type: Function,
        default () {
          return true
        }
      }
    },
    data () {
      return {
        loading: false
      }
    },
    computed: {
      ...mapState({
        errors: state => state.errors.items,
        gitTestMessage: state => state.flows.gitTestMessage
      }),

      currentGitTest () {
        if (this.gitTestMessage === undefined) {
          return gitTestStatus.default
        }

        const gitTest = gitTestStatus[this.gitTestMessage.status] || gitTestStatus.default
        let message = gitTest.message

        if (this.gitTestMessage.status === GIT_TEST_ERROR) {
          message += ' : ' + this.gitTestMessage.error
        }

        return {
          icon: gitTest.icon,
          class: gitTest.class,
          message: message
        }
      }
    },
    watch: {
      gitTestMessage (newValue) {
        if (newValue.status === GIT_TEST_DONE) {
          this.stop()
        }

        if (newValue.status === GIT_TEST_ERROR) {
          this.stop()
        }
      }
    },
    methods: {
      stop () {
        this.loading = false
        unsubscribeTopic.gitTest(this.wrapper.id)
      },

      onTestClick () {
        if (this.onBeforeTest()) {
          subscribeTopic.gitTest(this.$store, this.wrapper.id)

          this.$store.dispatch(actions.flows.gitTestStart, this.wrapper).then(() => {
            this.loading = true
          })
        }
      }
    }
  }
</script>

<style scoped>
  .custom-loader {
    animation: loader 1s infinite;
    display: flex;
  }

  @-moz-keyframes loader {
    from {
      transform: rotate(0);
    }
    to {
      transform: rotate(360deg);
    }
  }

  @-webkit-keyframes loader {
    from {
      transform: rotate(0);
    }
    to {
      transform: rotate(360deg);
    }
  }

  @-o-keyframes loader {
    from {
      transform: rotate(0);
    }
    to {
      transform: rotate(360deg);
    }
  }

  @keyframes loader {
    from {
      transform: rotate(0);
    }
    to {
      transform: rotate(360deg);
    }
  }
</style>